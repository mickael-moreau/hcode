<html>
<head>
    <link rel="stylesheet" type="text/css" href="libs/leaflet/leaflet.css" media="all" />
    <style>
    #map { height: 180px; }
    </style>
</head>
<body>

    <input type='file' id="board_input" title="Board Input">

    <div id="map"></div>

    <div id="game_init"></div>
    <div id="game_viewer"></div>

    <div id="log_viewer"></div>

    <script src="libs/ymljs/yaml.min.js" ></script>
    <script src="libs/leaflet/leaflet.js"></script>
    <script src="Tools.js" ></script>
    <script>
    // Map visualisation of running of resultings commandes :
    var southWest = L.latLng(40.206637,-3.3639186)
    , northEast = L.latLng(50.2958534,8.4115774)
    , maxBounds = L.latLngBounds(southWest, northEast);
    var map = L.map('map', {maxBounds:maxBounds}).setView([46.3113351,0.942722], 4); // 46.3113351,0.942722,5z
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    L.markerFromBoardElement = function(elt, max_x, max_y) {
        var x = maxBounds.getWest()
        + elt.loc.x / max_x * (maxBounds.getWest() - maxBounds.getEast());
        var y = maxBounds.getNorth()
        + elt.loc.y / max_y * (maxBounds.getNorth() - maxBounds.getSouth());
        var res = L.marker([y, x])
        .addTo(map)
        .bindPopup('<pre>' + window.YAML.stringify(elt) + '</pre>');// TODO : JsYaml.dump(elt)
        if ('drone' === elt.elt_type) {
            res.openPopup();
        }
        return res;
    }

    if (window.Worker) {
        var myWorker = new Worker("file:///Users/mickaelmoreau/goinfre/hcode/src/main.js");
        var need_init = true;

        document.getElementById('board_input').onchange = function(){
            var file = this.files[0];
            var reader = new FileReader();
            reader.onload = function(progressEvent){
                myWorker.onmessage = function(e) {
                    switch (e.data.type) {
                        case 'solution': {
                            var solution = e.data.solution;
                            var txt_solution = solution.length + '\n' + solution.join('\n');
                            document.body.innerHTML += '<pre>' + txt_solution + '</pre>';
                            download('output.txt', txt_solution);
                            Tools.info('Game solved');
                            Tools.info(solution);
                            break;
                        }
                        case 'print': {
                            if (need_init) {
                                document.getElementById('game_init')
                                .innerHTML = '<pre>' + e.data.print + '</pre>';
                                need_init = false;

                                for (var i = 0; i < e.data.board.warehouses.length; i++) {
                                    L.markerFromBoardElement(e.data.board.warehouses[i],
                                    e.data.board.nb_columns, e.data.board.nb_row);
                                }
                            }

                            // TODO : clean and reload L.markerFromBoardElement()

                            break;
                        }
                        case 'log': document.getElementById('log_viewer')
                        .innerHTML += '<p>' + e.data.log + '</p>';
                        break;
                        default: {
                            Tools.info('Unknow message from main web worker');
                            Tools.info(e);
                        }
                    }
                }

                // Entire file
                //console.log(this.result);
                myWorker.postMessage({
                    file_content:this.result,
                });
            };
            reader.readAsText(file);
        };
        //myWorker.postMessage([first.value,second.value]);
    } else {
        alert('You need web workers enabled for this code to run');
    }
    </script>
</body>
</html>
